#!/bin/bash

# Variables
remote="$1"
branch="$2"
depth_interval=100  # Fetch in chunks of 100 commits at a time
current_depth=$depth_interval

# Check for remote and branch arguments
if [ -z "$remote" ]; then
    echo "Please specify a remote to fetch from."
    exit 1
fi

if [ -z "$branch" ]; then
    echo "Please specify a branch to fetch."
    exit 1
fi

# Initialize a shallow clone of the specific branch with a minimal depth
git fetch $remote $branch --depth=1

# Incrementally deepen the clone of the branch
while true; do
    echo "Fetching up to $current_depth commits of branch $branch..."
    git fetch $remote $branch --depth=$current_depth

    # Check if we've fetched all commits
    before_fetch_count=$(git rev-list --count FETCH_HEAD)
    git fetch $remote $branch --depth=$((current_depth + depth_interval))
    after_fetch_count=$(git rev-list --count FETCH_HEAD)

    if [ "$before_fetch_count" -eq "$after_fetch_count" ]; then
        echo "All commits of branch $branch have been fetched."
        break
    fi

    # Increase the depth for the next iteration
    current_depth=$((current_depth + depth_interval))
done

echo "Fetching process for branch $branch completed."
